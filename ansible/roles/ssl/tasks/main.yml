---
# SSL/Let's Encrypt Role - HTTPS certificates

- name: Install certbot and required packages
  apt:
    name:
      - certbot
      - python3-certbot-nginx
    state: present
    update_cache: yes

# ═══════════════════════════════════════════════════════════════
# DEBUG CHECKPOINT 1: Before Certificate Generation
# ═══════════════════════════════════════════════════════════════
- name: "[DEBUG] Capture state before SSL certificate generation"
  include_role:
    name: debug-ssl
  vars:
    checkpoint_name: "01-before-certbot"
  when: enable_ssl | default(false) and domain_name is defined
  tags: [debug]

- name: Check if SSL certificate already exists
  stat:
    path: "/etc/letsencrypt/live/{{ domain_name }}/fullchain.pem"
  register: ssl_cert_exists
  when: enable_ssl | default(false) and domain_name is defined

- name: "[DEBUG] Display ssl_cert_exists variable structure"
  debug:
    msg: |
      ssl_cert_exists variable:
      {{ ssl_cert_exists | to_nice_yaml(indent=2) }}
  when: ssl_cert_exists is defined
  tags: [debug]

- name: Prompt for DNS configuration
  pause:
    prompt: |

      ========================================
      DNS CONFIGURATION REQUIRED
      ========================================

      Before obtaining SSL certificate, configure your DNS:

      Add an A record:
        Domain: {{ domain_name }}
        Type: A
        Value: {{ ansible_host }}
        TTL: 300 (or Auto)

      Wait 5-10 minutes for DNS propagation, then verify:
        dig {{ domain_name }}
        # or
        nslookup {{ domain_name }}

      Press ENTER when DNS is configured and propagated...

  when:
    - enable_ssl | default(false)
    - domain_name is defined
    - not ssl_cert_exists.stat.exists

- name: Obtain Let's Encrypt certificate
  command: >
    certbot certonly --nginx
    --non-interactive
    --agree-tos
    --email {{ letsencrypt_email }}
    --domain {{ domain_name }}
    {% if letsencrypt_staging | default(false) %}--staging{% endif %}
  when:
    - enable_ssl | default(false)
    - domain_name is defined
    - letsencrypt_email is defined
    - not ssl_cert_exists.stat.exists
  register: certbot_result
  notify: reload nginx

- name: "[DEBUG] Display certbot result"
  debug:
    msg: |
      Certbot execution result:
      Return code: {{ certbot_result.rc | default('N/A') }}
      Stdout: {{ certbot_result.stdout | default('N/A') }}
      Stderr: {{ certbot_result.stderr | default('N/A') }}
  when: certbot_result is defined
  tags: [debug]

- name: Re-check SSL certificate exists after certbot
  stat:
    path: "/etc/letsencrypt/live/{{ domain_name | default('localhost') }}/fullchain.pem"
  register: ssl_cert_exists_after

- name: "[DEBUG] Display ssl_cert_exists_after variable structure"
  debug:
    msg: |
      ssl_cert_exists_after variable:
      {{ ssl_cert_exists_after | to_nice_yaml(indent=2) }}
  when: ssl_cert_exists_after is defined
  tags: [debug]

# ═══════════════════════════════════════════════════════════════
# DEBUG CHECKPOINT 2: After Certificate Generation, Before Nginx Regen
# ═══════════════════════════════════════════════════════════════
- name: "[DEBUG] Capture state after certbot, before nginx regeneration"
  include_role:
    name: debug-ssl
  vars:
    checkpoint_name: "02-after-certbot-before-nginx-regen"
  when:
    - enable_ssl | default(false)
    - domain_name is defined
  tags: [debug]

- name: Regenerate nginx config with SSL enabled
  template:
    src: ../../nginx/templates/addaxai-connect.conf.j2
    dest: /etc/nginx/sites-available/addaxai-connect.conf
    owner: root
    group: root
    mode: '0644'
  vars:
    ssl_cert_exists: "{{ ssl_cert_exists_after }}"
  when:
    - enable_ssl | default(false)
    - domain_name is defined
    - ssl_cert_exists_after.stat.exists
  notify: reload nginx
  register: nginx_regen_result

- name: "[DEBUG] Display nginx regeneration result"
  debug:
    msg: |
      Nginx config regeneration:
      Changed: {{ nginx_regen_result.changed | default('N/A') }}
      Template vars passed:
        ssl_cert_exists: {{ ssl_cert_exists_after | to_nice_yaml(indent=2) }}
  when: nginx_regen_result is defined
  tags: [debug]

- name: Flush handlers to reload nginx with SSL
  meta: flush_handlers

# ═══════════════════════════════════════════════════════════════
# DEBUG CHECKPOINT 3: After Nginx Reload, Before Finalize
# ═══════════════════════════════════════════════════════════════
- name: "[DEBUG] Capture state after nginx reload, before finalize"
  include_role:
    name: debug-ssl
  vars:
    checkpoint_name: "03-after-nginx-reload-before-finalize"
  when:
    - enable_ssl | default(false)
    - domain_name is defined
  tags: [debug]

- name: Create certbot renewal script
  template:
    src: certbot-renew.sh.j2
    dest: /usr/local/bin/certbot-renew.sh
    owner: root
    group: root
    mode: '0755'
  when: enable_ssl | default(false)

- name: Set up automatic certificate renewal (cron)
  cron:
    name: "Renew Let's Encrypt certificates"
    minute: "0"
    hour: "3"
    day: "*"
    month: "*"
    weekday: "0"
    user: root
    job: "/usr/local/bin/certbot-renew.sh >> /var/log/certbot-renew.log 2>&1"
    state: present
  when: enable_ssl | default(false)

# Note: SSL finalization now runs in playbook post_tasks (after all roles complete)
# This ensures correct timing and variable scope for HTTPS configuration

- name: Wait for HTTPS to respond via public DNS
  uri:
    url: "https://{{ domain_name }}/health"
    method: GET
    status_code: 200
    timeout: 10
    validate_certs: false  # Set to true when using production certs (letsencrypt_staging: false)
  delegate_to: localhost
  become: false
  run_once: true
  retries: 30
  delay: 20
  register: https_check
  until: https_check.status == 200
  when:
    - enable_ssl | default(false)
    - domain_name is defined
    - ssl_cert_exists_after.stat.exists | default(false)
  failed_when: false  # Don't fail the playbook, just log the result
  tags: [ssl, web]

- name: "[DEBUG] Display HTTPS health check result"
  debug:
    msg: |
      HTTPS Health Check Result:
      Status: {{ https_check.status | default('FAILED - No status') }}
      {% if https_check.msg is defined %}
      Message: {{ https_check.msg }}
      {% endif %}
      {% if https_check.status != 200 %}
      ⚠️  HTTPS is not responding correctly!
      {% endif %}
  when: https_check is defined
  tags: [debug]

# ═══════════════════════════════════════════════════════════════
# DEBUG CHECKPOINT 4: End of SSL Role
# ═══════════════════════════════════════════════════════════════
- name: "[DEBUG] Capture state at end of SSL role (before finalize in post_tasks)"
  include_role:
    name: debug-ssl
  vars:
    checkpoint_name: "04-end-of-ssl-role"
  when:
    - enable_ssl | default(false)
    - domain_name is defined
  tags: [debug]

- name: Display SSL configuration info
  debug:
    msg: |
      ========================================
      SSL Configuration
      ========================================
      {% if enable_ssl | default(false) and domain_name is defined %}
      ✅ SSL Enabled
      Domain: {{ domain_name }}
      Certificate: /etc/letsencrypt/live/{{ domain_name }}/fullchain.pem
      Auto-renewal: Configured (runs every Sunday at 3 AM)

      {% if https_check is defined and https_check.status == 200 %}
      ✅ HTTPS is responding correctly
      {% else %}
      ⚠️  HTTPS health check failed or was skipped
      {% endif %}

      Debug data collected at: /tmp/ansible-ssl-debug/
      {% else %}
      ⚠️  SSL Not Configured
      To enable SSL:
      1. Set domain_name in group_vars
      2. Set letsencrypt_email in group_vars
      3. Set enable_ssl: true
      4. Point your domain DNS to: {{ ansible_host }}
      5. Re-run the playbook
      {% endif %}
