---
# Nginx Role - Reverse proxy and frontend serving

- name: Install nginx
  apt:
    name: nginx
    state: present
    update_cache: yes

- name: Remove default nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: restart nginx

- name: Create placeholder directory
  file:
    path: /var/www/addaxai-placeholder
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'

- name: Create placeholder HTML page
  template:
    src: placeholder.html.j2
    dest: /var/www/addaxai-placeholder/index.html
    owner: www-data
    group: www-data
    mode: '0644'

- name: Check if SSL certificate exists
  stat:
    path: "/etc/letsencrypt/live/{{ domain_name | default('') }}/fullchain.pem"
  register: ssl_cert_exists
  when: enable_ssl | default(false) and domain_name is defined and domain_name != ''

- name: Create nginx configuration for AddaxAI Connect
  template:
    src: addaxai-connect.conf.j2
    dest: /etc/nginx/sites-available/addaxai-connect.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart nginx

- name: Enable AddaxAI Connect nginx site
  file:
    src: /etc/nginx/sites-available/addaxai-connect.conf
    dest: /etc/nginx/sites-enabled/addaxai-connect.conf
    state: link
  notify: restart nginx

- name: Install apache2-utils for htpasswd
  apt:
    name: apache2-utils
    state: present

- name: Install python3-passlib for htpasswd module
  apt:
    name: python3-passlib
    state: present

- name: Create htpasswd file for monitoring/admin access
  htpasswd:
    path: /etc/nginx/.htpasswd
    name: admin
    password: "{{ monitoring_password }}"
    owner: root
    group: www-data
    mode: '0640'
  when: monitoring_password is defined
  notify: restart nginx

- name: Test nginx configuration
  command: nginx -t
  register: nginx_test
  changed_when: false
  failed_when: nginx_test.rc != 0

- name: Ensure nginx service is enabled and started
  systemd:
    name: nginx
    state: started
    enabled: yes

- name: Display nginx configuration info
  debug:
    msg: |
      ========================================
      Nginx Configured
      ========================================
      HTTP: http://{{ ansible_host }}
      API Proxy: http://{{ ansible_host }}/api → http://localhost:8000
      WebSocket: http://{{ ansible_host }}/ws → ws://localhost:8000

      {% if enable_ssl | default(false) %}
      HTTPS: https://{{ domain_name }}
      {% else %}
      HTTPS not configured (set domain_name and enable_ssl to enable)
      {% endif %}
