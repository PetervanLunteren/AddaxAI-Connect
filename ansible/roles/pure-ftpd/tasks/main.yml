---
# Pure-FTPd Role - FTPS Server for Camera Trap Image Uploads

- name: Install Pure-FTPd
  apt:
    name: pure-ftpd
    state: present
    update_cache: yes

- name: Install OpenSSL for SSL certificates
  apt:
    name: openssl
    state: present

- name: Ensure parent directory exists for FTPS uploads
  file:
    path: "{{ ftps_upload_dir | default('/opt/addaxai-connect/uploads') | dirname }}"
    state: directory
    mode: '0755'

- name: Create FTPS user for camera trap uploads
  user:
    name: "{{ ftps_username | default('camera') }}"
    shell: /bin/bash
    home: "{{ ftps_upload_dir | default('/opt/addaxai-connect/uploads') }}"
    create_home: yes
    state: present
    password: "{{ ftps_password | password_hash('sha512') if ftps_password is defined else omit }}"

- name: Remove skeleton files from FTPS upload directory
  file:
    path: "{{ ftps_upload_dir | default('/opt/addaxai-connect/uploads') }}/{{ item }}"
    state: absent
  loop:
    - .bash_logout
    - .bashrc
    - .profile
    - .cloud-locale-test.skip

- name: Set permissions on FTPS upload directory
  file:
    path: "{{ ftps_upload_dir | default('/opt/addaxai-connect/uploads') }}"
    state: directory
    owner: "{{ ftps_username | default('camera') }}"
    group: "{{ ftps_username | default('camera') }}"
    mode: '2775'  # setgid bit ensures new files inherit group ownership

- name: Set permissions recursively on existing subdirectories
  shell: |
    find "{{ ftps_upload_dir | default('/opt/addaxai-connect/uploads') }}" -type d -exec chmod 2775 {} \;
    find "{{ ftps_upload_dir | default('/opt/addaxai-connect/uploads') }}" -type d -exec chown {{ ftps_username | default('camera') }}:{{ ftps_username | default('camera') }} {} \;
  changed_when: false

- name: Add ubuntu user to camera group for Docker access
  user:
    name: "{{ app_user | default('ubuntu') }}"
    groups: "{{ ftps_username | default('camera') }}"
    append: yes

- name: Check if Let's Encrypt certificate exists
  stat:
    path: "/etc/letsencrypt/live/{{ domain_name | default('') }}/fullchain.pem"
  register: letsencrypt_cert_exists
  when: enable_ssl | default(false) and domain_name is defined and domain_name != ''

- name: Use Let's Encrypt certificate for FTPS (if available)
  block:
    - name: Remove old self-signed Pure-FTPd certificate if exists
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/ssl/certs/pure-ftpd.crt
        - /etc/ssl/private/pure-ftpd.key

    - name: Create symlink for Pure-FTPd cert to Let's Encrypt
      file:
        src: "/etc/letsencrypt/live/{{ domain_name }}/fullchain.pem"
        dest: /etc/ssl/certs/pure-ftpd.crt
        state: link
        force: yes

    - name: Create symlink for Pure-FTPd key to Let's Encrypt
      file:
        src: "/etc/letsencrypt/live/{{ domain_name }}/privkey.pem"
        dest: /etc/ssl/private/pure-ftpd.key
        state: link
        force: yes
  when:
    - enable_ssl | default(false)
    - domain_name is defined and domain_name != ''
    - letsencrypt_cert_exists.stat.exists

- name: Generate self-signed SSL certificate for FTPS (fallback only)
  command: >
    openssl req -x509 -nodes -days 365 -newkey rsa:2048
    -keyout /etc/ssl/private/pure-ftpd.key
    -out /etc/ssl/certs/pure-ftpd.crt
    -subj "/C=US/ST=State/L=City/O=AddaxAI/CN={{ ansible_host }}"
  args:
    creates: /etc/ssl/certs/pure-ftpd.crt
  when: not (enable_ssl | default(false) and domain_name is defined and letsencrypt_cert_exists.stat.exists | default(false))

- name: Set permissions on SSL private key (self-signed fallback only)
  file:
    path: /etc/ssl/private/pure-ftpd.key
    mode: '0600'
    owner: root
    group: root
  when: not (enable_ssl | default(false) and domain_name is defined and letsencrypt_cert_exists.stat.exists | default(false))

- name: Configure Pure-FTPd daemon settings
  lineinfile:
    path: /etc/default/pure-ftpd-common
    regexp: "^{{ item.key }}="
    line: "{{ item.key }}={{ item.value }}"
    create: yes
    owner: root
    group: root
    mode: '0644'
  loop:
    - { key: 'STANDALONE_OR_INETD', value: 'standalone' }
    - { key: 'VIRTUALCHROOT', value: 'true' }
  notify: restart pure-ftpd

- name: Create Pure-FTPd auth directory
  file:
    path: /etc/pure-ftpd/auth
    state: directory
    mode: '0755'

- name: Enable Unix authentication
  file:
    src: /etc/pure-ftpd/conf/UnixAuthentication
    dest: /etc/pure-ftpd/auth/50unix
    state: link
    force: yes

- name: Enable PAM authentication
  file:
    src: /etc/pure-ftpd/conf/PAMAuthentication
    dest: /etc/pure-ftpd/auth/70pam
    state: link
    force: yes

- name: Configure Pure-FTPd options via conf files
  copy:
    content: "{{ item.content }}"
    dest: "/etc/pure-ftpd/conf/{{ item.name }}"
    mode: '0644'
    owner: root
    group: root
  loop:
    - { name: 'ChrootEveryone', content: 'yes' }
    - { name: 'NoAnonymous', content: 'yes' }
    - { name: 'MaxClientsNumber', content: '10' }
    - { name: 'MaxClientsPerIP', content: '5' }
    - { name: 'Daemonize', content: 'yes' }
    - { name: 'DisplayDotFiles', content: 'yes' }
    - { name: 'DontResolve', content: 'yes' }
    - { name: 'MaxIdleTime', content: '15' }
    - { name: 'PAMAuthentication', content: 'yes' }
    - { name: 'UnixAuthentication', content: 'yes' }
    - { name: 'LimitRecursion', content: '10000 8' }
    - { name: 'AnonymousCanCreateDirs', content: 'no' }
    - { name: 'MaxLoad', content: '4' }
    - { name: 'PassivePortRange', content: "{{ ftps_passive_port_min | default('40000') }} {{ ftps_passive_port_max | default('50000') }}" }
    - { name: 'ForcePassiveIP', content: "{{ ansible_host }}" }
    - { name: 'AntiWarez', content: 'yes' }
    - { name: 'Umask', content: '133 022' }
    - { name: 'MinUID', content: '1000' }
    - { name: 'AllowUserFXP', content: 'no' }
    - { name: 'AllowAnonymousFXP', content: 'no' }
    - { name: 'ProhibitDotFilesWrite', content: 'no' }
    - { name: 'ProhibitDotFilesRead', content: 'no' }
    - { name: 'AutoRename', content: 'yes' }
    - { name: 'AnonymousCantUpload', content: 'yes' }
    - { name: 'MaxDiskUsage', content: '95' }
    - { name: 'CustomerProof', content: 'yes' }
    - { name: 'NoTruncate', content: 'yes' }
    - { name: 'TLS', content: '1' }
  notify: restart pure-ftpd

- name: Disable CallUploadScript (using AutoRename instead)
  file:
    path: /etc/pure-ftpd/conf/CallUploadScript
    state: absent
  notify: restart pure-ftpd

- name: Remove invalid CertFile configuration
  file:
    path: /etc/pure-ftpd/conf/CertFile
    state: absent
  notify: restart pure-ftpd

- name: Create combined PEM file for Pure-FTPd TLS
  shell: |
    cat /etc/ssl/certs/pure-ftpd.crt /etc/ssl/private/pure-ftpd.key > /etc/ssl/private/pure-ftpd.pem
    chmod 600 /etc/ssl/private/pure-ftpd.pem
  args:
    creates: /etc/ssl/private/pure-ftpd.pem
  notify: restart pure-ftpd

- name: Deploy upload rename script
  copy:
    src: ftps-rename-uploads.sh
    dest: /usr/local/bin/ftps-rename-uploads.sh
    owner: root
    group: root
    mode: '0755'

- name: Disable init script's UPLOADSCRIPT (we use our own systemd service)
  lineinfile:
    path: /etc/default/pure-ftpd-common
    regexp: '^UPLOADSCRIPT='
    line: 'UPLOADSCRIPT='
    create: yes
  notify: restart pure-ftpd

- name: Deploy pure-uploadscript systemd service
  template:
    src: pure-uploadscript.service.j2
    dest: /etc/systemd/system/pure-uploadscript.service
    owner: root
    group: root
    mode: '0644'
  notify: restart pure-uploadscript

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes

- name: Ensure Pure-FTPd service is enabled and started
  systemd:
    name: pure-ftpd
    state: started
    enabled: yes

- name: Ensure pure-uploadscript service is disabled and stopped
  systemd:
    name: pure-uploadscript
    state: stopped
    enabled: no
  ignore_errors: yes  # Service might not exist on first deployment

- name: Display FTPS connection information
  debug:
    msg: |
      ========================================
      FTPS Server Configured (Pure-FTPd)
      ========================================
      Host: {{ ansible_host }}
      Port: 21 (FTP), 990 (FTPS)
      Username: {{ ftps_username | default('camera') }}
      Upload directory: {{ ftps_upload_dir | default('/opt/addaxai-connect/uploads') }}
      Features:
        - Atomic uploads: Files uploaded to temp, renamed when complete
        - Auto-rename: Duplicate files get numeric suffix (.1, .2, etc)

      Connect with: ftp://{{ ftps_username | default('camera') }}@{{ ansible_host }}
      Use FTPS (explicit TLS) for secure connection.
