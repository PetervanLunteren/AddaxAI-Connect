---
# App Deploy Role - Deploy Docker Compose stack
# Note: docker-compose.yml comes from git repository (single source of truth)
# Only .env is templated to inject secrets and environment-specific values

- name: Create .env file from template
  template:
    src: .env.j2
    dest: "{{ app_directory | default('/opt/addaxai-connect') }}/.env"
    owner: "{{ app_user | default('ubuntu') }}"
    group: "{{ app_user | default('ubuntu') }}"
    mode: '0600'

- name: Check if monitoring configs are directories (Docker created them incorrectly)
  stat:
    path: "{{ app_directory | default('/opt/addaxai-connect') }}/monitoring/{{ item }}"
  register: monitoring_check
  loop:
    - prometheus.yml
    - loki-config.yml
    - promtail-config.yml

- name: Stop Docker containers if monitoring configs are directories
  command: docker compose down
  args:
    chdir: "{{ app_directory | default('/opt/addaxai-connect') }}"
  become_user: "{{ app_user | default('ubuntu') }}"
  when: monitoring_check.results | selectattr('stat.isdir', 'defined') | selectattr('stat.isdir') | list | length > 0
  ignore_errors: true

- name: Remove incorrectly created monitoring directories
  file:
    path: "{{ app_directory | default('/opt/addaxai-connect') }}/monitoring/{{ item.item }}"
    state: absent
  loop: "{{ monitoring_check.results }}"
  when: item.stat.exists and item.stat.isdir

- name: Create required directories for volumes
  file:
    path: "{{ app_directory | default('/opt/addaxai-connect') }}/{{ item }}"
    state: directory
    owner: "{{ app_user | default('ubuntu') }}"
    group: "{{ app_user | default('ubuntu') }}"
    mode: '0755'
  loop:
    - data/redis
    - data/minio
    - data/prometheus
    - data/loki
    - logs

- name: Create postgres data directory with correct ownership
  file:
    path: "{{ app_directory | default('/opt/addaxai-connect') }}/data/postgres"
    state: directory
    owner: "999"
    group: "999"
    mode: '0700'

- name: Pull Docker images
  command: docker compose pull
  args:
    chdir: "{{ app_directory | default('/opt/addaxai-connect') }}"
  become_user: "{{ app_user | default('ubuntu') }}"
  register: docker_pull
  changed_when: "'Pulling' in docker_pull.stdout"
  when: deploy_pull_images | default(true)

- name: Check SMTP connectivity (for email verification)
  shell: timeout 5 bash -c 'cat < /dev/null > /dev/tcp/{{ mail_server | default("smtp.gmail.com") }}/{{ mail_port | default(587) }}'
  register: smtp_check
  failed_when: false
  changed_when: false

- name: Display SMTP connectivity warning
  debug:
    msg: |
      ========================================
      SMTP Connectivity Check
      ========================================
      Testing connection to {{ mail_server | default("smtp.gmail.com") }}:{{ mail_port | default(587) }}...

      {% if smtp_check.rc == 0 %}
      ✓ SMTP connection successful
      {% else %}
      ✗ SMTP connection FAILED

      ⚠️  WARNING: SMTP ports appear to be blocked!

      This is common on new cloud provider accounts to prevent spam.
      If container startup takes unusually long or times out, SMTP connection
      timeouts are the likely cause.

      Impact:
      - User registration will fail (cannot send verification emails)
      - Containers may take longer to start due to SMTP connection timeouts

      Solutions:
      1. Contact your cloud provider to unblock SMTP ports (25, 587, 465)
      2. Use an alternative email service (SendGrid, Mailgun, AWS SES)
      3. Manually verify users via database:
         docker compose exec -T postgres psql -U addaxai -d addaxai_connect \
           -c "UPDATE users SET is_verified = true WHERE email = 'user@example.com';"
      {% endif %}
      ========================================

- name: Start Docker Compose services (force recreate to fix mount issues)
  command: docker compose up -d --force-recreate
  args:
    chdir: "{{ app_directory | default('/opt/addaxai-connect') }}"
  become_user: "{{ app_user | default('ubuntu') }}"
  register: docker_up
  changed_when: "'Started' in docker_up.stdout or 'Created' in docker_up.stdout or 'Recreated' in docker_up.stdout"
  async: 2700  # 45 minutes for initial build (7 service images, ~14GB total)
  poll: 10

- name: Wait for services to be healthy
  command: docker compose ps --format json
  args:
    chdir: "{{ app_directory | default('/opt/addaxai-connect') }}"
  become_user: "{{ app_user | default('ubuntu') }}"
  register: compose_status
  until: compose_status.rc == 0
  retries: 5
  delay: 10
  changed_when: false

- name: Fix ownership of FTPS upload directory (after git deploy overwrites it)
  file:
    path: "{{ ftps_upload_dir | default('/opt/addaxai-connect/uploads') }}"
    state: directory
    owner: "{{ ftps_username | default('camera') }}"
    group: "{{ ftps_username | default('camera') }}"
    mode: '2775'  # setgid bit + group write permissions for ubuntu user
    recurse: yes
  when: ftps_username is defined

- name: Ensure app user can read uploads (for Docker containers)
  user:
    name: "{{ app_user | default('ubuntu') }}"
    groups: "{{ ftps_username | default('camera') }}"
    append: yes
  when: ftps_username is defined

- name: Initialize database with Alembic migrations
  command: bash scripts/init-database.sh
  args:
    chdir: "{{ app_directory | default('/opt/addaxai-connect') }}"
  become_user: "{{ app_user | default('ubuntu') }}"
  register: db_init
  changed_when: "'✅ Database initialized!' in db_init.stdout"

- name: Display database initialization result
  debug:
    var: db_init.stdout_lines
  when: db_init is defined

- name: Create initial server admin account
  command: >
    docker compose exec -T
    -e SUPERADMIN_EMAIL="{{ admin_email }}"
    -e DATABASE_URL="postgresql://{{ db_user | default('addaxai') }}:{{ db_password }}@postgres:5432/{{ db_name | default('addaxai_connect') }}"
    api
    python /app/scripts/create_superuser.py
  args:
    chdir: "{{ app_directory | default('/opt/addaxai-connect') }}"
  become_user: "{{ app_user | default('ubuntu') }}"
  register: superuser_creation
  when: admin_email is defined and admin_email | length > 0
  failed_when:
    - superuser_creation.rc != 0
    - "'already exists' not in superuser_creation.stdout"

- name: Display superuser creation result
  debug:
    var: superuser_creation.stdout_lines
  when: admin_email is defined and admin_email | length > 0

- name: Check API container logs for errors
  command: docker compose logs --tail=50 api
  args:
    chdir: "{{ app_directory | default('/opt/addaxai-connect') }}"
  become_user: "{{ app_user | default('ubuntu') }}"
  register: api_logs
  changed_when: false

- name: Display API container logs
  debug:
    var: api_logs.stdout_lines

# DEPRECATED: Using allowlist-based admin assignment instead
# Admins now register normally, and automatically become admins based on email allowlist
# - name: Create superuser account
#   command: >
#     docker compose exec -T
#     -e SUPERADMIN_EMAIL="{{ superadmin_email }}"
#     -e DATABASE_URL="postgresql://{{ db_user | default('addaxai') }}:{{ db_password }}@postgres:5432/{{ db_name | default('addaxai_connect') }}"
#     api
#     python3 /app/scripts/create_superuser.py
#   args:
#     chdir: "{{ app_directory | default('/opt/addaxai-connect') }}"
#   become_user: "{{ app_user | default('ubuntu') }}"
#   register: superuser_create
#   until: superuser_create.rc == 0
#   retries: 10
#   delay: 3
#   changed_when: "'Superuser created' in superuser_create.stdout"
#   when: superadmin_email is defined and superadmin_email != ""
#
# - name: Display superuser creation result
#   debug:
#     var: superuser_create.stdout_lines
#   when: superuser_create is defined

- name: Display deployment information
  debug:
    msg: |
      ========================================
      Docker Compose Stack Deployed
      ========================================
      Location: {{ app_directory | default('/opt/addaxai-connect') }}

      Services running:
      - PostgreSQL (port 5432)
      - Redis (port 6379)
      - MinIO (ports 9000, 9001)
      - FastAPI (port 8000)
      - Prometheus (port 9090)
      - Loki (port 3100)

      Initial Server Admin Account:
      {% if admin_email is defined and admin_email | length > 0 %}
      - Email: {{ admin_email }}
      - A temporary password has been generated (check output above)

      Next Steps:
      1. Go to https://{{ domain_name | default(ansible_host) }}/login
      2. Log in with the admin email and temporary password
      3. Go to your profile to change your password
      4. You can now invite other users from the web interface!
      {% else %}
      - No admin email configured
      - Add email to admin_email in group_vars/dev.yml and redeploy
      {% endif %}

      Useful commands:
      docker compose ps              # Check service status
      docker compose logs -f         # View logs
      docker compose restart         # Restart all services
      docker compose down            # Stop all services

      Access:
      - Web UI: https://{{ domain_name | default(ansible_host) }}
      - API: https://{{ domain_name | default(ansible_host) }}/api
      - MinIO Console: http://{{ ansible_host }}:9001
      - Prometheus: http://{{ ansible_host }}:9090
