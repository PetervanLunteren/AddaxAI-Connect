---
# App Deploy Role - Deploy Docker Compose stack
# Note: docker-compose.yml comes from git repository (single source of truth)
# Only .env is templated to inject secrets and environment-specific values

- name: Create .env file from template
  template:
    src: .env.j2
    dest: "{{ app_directory | default('/opt/addaxai-connect') }}/.env"
    owner: "{{ app_user | default('ubuntu') }}"
    group: "{{ app_user | default('ubuntu') }}"
    mode: '0600'

- name: Check if monitoring configs are directories (Docker created them incorrectly)
  stat:
    path: "{{ app_directory | default('/opt/addaxai-connect') }}/monitoring/{{ item }}"
  register: monitoring_check
  loop:
    - prometheus.yml
    - loki-config.yml
    - promtail-config.yml

- name: Stop Docker containers if monitoring configs are directories
  command: docker compose down
  args:
    chdir: "{{ app_directory | default('/opt/addaxai-connect') }}"
  become_user: "{{ app_user | default('ubuntu') }}"
  when: monitoring_check.results | selectattr('stat.isdir', 'defined') | selectattr('stat.isdir') | list | length > 0
  ignore_errors: true

- name: Remove incorrectly created monitoring directories
  file:
    path: "{{ app_directory | default('/opt/addaxai-connect') }}/monitoring/{{ item.item }}"
    state: absent
  loop: "{{ monitoring_check.results }}"
  when: item.stat.exists and item.stat.isdir

- name: Create required directories for volumes
  file:
    path: "{{ app_directory | default('/opt/addaxai-connect') }}/{{ item }}"
    state: directory
    owner: "{{ app_user | default('ubuntu') }}"
    group: "{{ app_user | default('ubuntu') }}"
    mode: '0755'
  loop:
    - data/redis
    - data/minio
    - data/prometheus
    - data/loki
    - logs

- name: Create postgres data directory with correct ownership
  file:
    path: "{{ app_directory | default('/opt/addaxai-connect') }}/data/postgres"
    state: directory
    owner: "999"
    group: "999"
    mode: '0700'

- name: Create models directory structure
  file:
    path: "{{ app_directory | default('/opt/addaxai-connect') }}/models/{{ item }}"
    state: directory
    owner: "{{ app_user | default('ubuntu') }}"
    group: "{{ app_user | default('ubuntu') }}"
    mode: '0755'
  loop:
    - detection
    - classification

- name: Download MegaDetector model (900MB - may take 10-15 minutes)
  get_url:
    url: "https://github.com/agentmorris/MegaDetector/releases/download/v1000.0/md_v1000.0.0-redwood.pt"
    dest: "{{ app_directory | default('/opt/addaxai-connect') }}/models/detection/md_v1000.0.0-redwood.pt"
    owner: "{{ app_user | default('ubuntu') }}"
    group: "{{ app_user | default('ubuntu') }}"
    mode: '0644'
    timeout: 1800  # 30 minutes for download
  retries: 3
  delay: 10
  register: detection_model_download

- name: Download DeepFaune classification model (1.2GB - may take 10-15 minutes)
  get_url:
    url: "https://huggingface.co/Addax-Data-Science/Deepfaune_v1.4/resolve/main/deepfaune-vit_large_patch14_dinov2.lvd142m.v4.pt?download=true"
    dest: "{{ app_directory | default('/opt/addaxai-connect') }}/models/classification/deepfaune-vit_large_patch14_dinov2.lvd142m.v4.pt"
    owner: "{{ app_user | default('ubuntu') }}"
    group: "{{ app_user | default('ubuntu') }}"
    mode: '0644'
    timeout: 1800  # 30 minutes for download
  retries: 3
  delay: 10
  register: classification_model_download

- name: Display model download results
  debug:
    msg: |
      MegaDetector: {{ 'Downloaded' if detection_model_download.changed else 'Already cached' }}
      DeepFaune: {{ 'Downloaded' if classification_model_download.changed else 'Already cached' }}

- name: Pull Docker images
  command: docker compose pull
  args:
    chdir: "{{ app_directory | default('/opt/addaxai-connect') }}"
  become_user: "{{ app_user | default('ubuntu') }}"
  register: docker_pull
  changed_when: "'Pulling' in docker_pull.stdout"
  when: deploy_pull_images | default(true)

- name: Build Docker Compose images
  command: docker compose build
  args:
    chdir: "{{ app_directory | default('/opt/addaxai-connect') }}"
  become_user: "{{ app_user | default('ubuntu') }}"
  register: docker_build
  changed_when: "'Building' in docker_build.stderr or 'Built' in docker_build.stderr"
  async: 2700  # 45 minutes - building all 7 service images on first deploy
  poll: 10

- name: Start Docker Compose services (force recreate to fix mount issues)
  command: docker compose up -d --force-recreate
  args:
    chdir: "{{ app_directory | default('/opt/addaxai-connect') }}"
  become_user: "{{ app_user | default('ubuntu') }}"
  register: docker_up
  changed_when: "'Started' in docker_up.stdout or 'Created' in docker_up.stdout or 'Recreated' in docker_up.stdout"
  async: 600  # 10 minutes - starting pre-built containers
  poll: 10

- name: Wait for services to be healthy
  command: docker compose ps --format json
  args:
    chdir: "{{ app_directory | default('/opt/addaxai-connect') }}"
  become_user: "{{ app_user | default('ubuntu') }}"
  register: compose_status
  until: compose_status.rc == 0
  retries: 5
  delay: 10
  changed_when: false

- name: Fix ownership of FTPS upload directory (after git deploy overwrites it)
  file:
    path: "{{ ftps_upload_dir | default('/opt/addaxai-connect/uploads') }}"
    state: directory
    owner: "{{ ftps_username | default('camera') }}"
    group: "{{ ftps_username | default('camera') }}"
    mode: '2775'  # setgid bit + group write permissions for ubuntu user
    recurse: yes
  when: ftps_username is defined

- name: Ensure app user can read uploads (for Docker containers)
  user:
    name: "{{ app_user | default('ubuntu') }}"
    groups: "{{ ftps_username | default('camera') }}"
    append: yes
  when: ftps_username is defined

- name: Initialize database with Alembic migrations
  command: bash scripts/init-database.sh
  args:
    chdir: "{{ app_directory | default('/opt/addaxai-connect') }}"
  become_user: "{{ app_user | default('ubuntu') }}"
  register: db_init
  changed_when: "'✅ Database initialized!' in db_init.stdout"

- name: Display database initialization result
  debug:
    var: db_init.stdout_lines
  when: db_init is defined

- name: Seed email allowlist with admin entries
  command: >
    docker compose exec -T postgres
    psql -U {{ db_user | default('addaxai') }}
    -d {{ db_name | default('addaxai_connect') }}
    -c "INSERT INTO email_allowlist (email, is_superuser) VALUES ('{{ item }}', true) ON CONFLICT (email) DO UPDATE SET is_superuser = true;"
  args:
    chdir: "{{ app_directory | default('/opt/addaxai-connect') }}"
  become_user: "{{ app_user | default('ubuntu') }}"
  loop: "{{ admin_emails | default([]) }}"
  register: allowlist_seed
  changed_when: "'INSERT' in allowlist_seed.stdout"
  when: admin_emails is defined and admin_emails | length > 0

- name: Display allowlist seeding result
  debug:
    msg: "✅ Seeded {{ admin_emails | length }} admin email(s) to allowlist: {{ admin_emails | join(', ') }}"
  when: admin_emails is defined and admin_emails | length > 0

- name: Check API container logs for errors
  command: docker compose logs --tail=50 api
  args:
    chdir: "{{ app_directory | default('/opt/addaxai-connect') }}"
  become_user: "{{ app_user | default('ubuntu') }}"
  register: api_logs
  changed_when: false

- name: Display API container logs
  debug:
    var: api_logs.stdout_lines

# DEPRECATED: Using allowlist-based admin assignment instead
# Admins now register normally, and automatically become admins based on email allowlist
# - name: Create superuser account
#   command: >
#     docker compose exec -T
#     -e SUPERADMIN_EMAIL="{{ superadmin_email }}"
#     -e DATABASE_URL="postgresql://{{ db_user | default('addaxai') }}:{{ db_password }}@postgres:5432/{{ db_name | default('addaxai_connect') }}"
#     api
#     python3 /app/scripts/create_superuser.py
#   args:
#     chdir: "{{ app_directory | default('/opt/addaxai-connect') }}"
#   become_user: "{{ app_user | default('ubuntu') }}"
#   register: superuser_create
#   until: superuser_create.rc == 0
#   retries: 10
#   delay: 3
#   changed_when: "'Superuser created' in superuser_create.stdout"
#   when: superadmin_email is defined and superadmin_email != ""
#
# - name: Display superuser creation result
#   debug:
#     var: superuser_create.stdout_lines
#   when: superuser_create is defined

- name: Display deployment information
  debug:
    msg: |
      ========================================
      Docker Compose Stack Deployed
      ========================================
      Location: {{ app_directory | default('/opt/addaxai-connect') }}

      Services running:
      - PostgreSQL (port 5432)
      - Redis (port 6379)
      - MinIO (ports 9000, 9001)
      - FastAPI (port 8000)
      - Prometheus (port 9090)
      - Loki (port 3100)

      Admin Email Allowlist Seeded:
      {% if admin_emails is defined and admin_emails | length > 0 %}
      {% for email in admin_emails %}
      - {{ email }} (server admin)
      {% endfor %}

      Next Steps:
      1. Go to https://{{ domain_name | default(ansible_host) }}/register
      2. Register with one of the admin emails above
      3. Check email for verification link
      4. After verification, you'll have full admin access!
      {% else %}
      - No admin emails configured
      - Add emails to admin_emails in group_vars/dev.yml
      {% endif %}

      Useful commands:
      docker compose ps              # Check service status
      docker compose logs -f         # View logs
      docker compose restart         # Restart all services
      docker compose down            # Stop all services

      Access:
      - Web UI: https://{{ domain_name | default(ansible_host) }}
      - API: https://{{ domain_name | default(ansible_host) }}/api
      - MinIO Console: http://{{ ansible_host }}:9001
      - Prometheus: http://{{ ansible_host }}:9090
