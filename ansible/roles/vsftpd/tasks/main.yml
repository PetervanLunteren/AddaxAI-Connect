---
# vsftpd Role - FTPS Server for Camera Trap Image Uploads

- name: Install vsftpd
  apt:
    name: vsftpd
    state: present
    update_cache: yes

- name: Install OpenSSL for SSL certificates
  apt:
    name: openssl
    state: present

- name: Ensure parent directory exists for FTPS uploads
  file:
    path: "{{ ftps_upload_dir | default('/opt/addaxai-connect/uploads') | dirname }}"
    state: directory
    mode: '0755'

- name: Create FTPS user for camera trap uploads
  user:
    name: "{{ ftps_username | default('camera') }}"
    shell: /bin/bash
    home: "{{ ftps_upload_dir | default('/opt/addaxai-connect/uploads') }}"
    create_home: yes
    state: present
    password: "{{ ftps_password | password_hash('sha512') if ftps_password is defined else omit }}"

- name: Remove skeleton files from FTPS upload directory
  file:
    path: "{{ ftps_upload_dir | default('/opt/addaxai-connect/uploads') }}/{{ item }}"
    state: absent
  loop:
    - .bash_logout
    - .bashrc
    - .profile
    - .cloud-locale-test.skip

- name: Set permissions on FTPS upload directory
  file:
    path: "{{ ftps_upload_dir | default('/opt/addaxai-connect/uploads') }}"
    state: directory
    owner: "{{ ftps_username | default('camera') }}"
    group: "{{ ftps_username | default('camera') }}"
    mode: '2775'  # setgid bit ensures new files inherit group ownership

- name: Set permissions recursively on existing subdirectories
  shell: |
    find "{{ ftps_upload_dir | default('/opt/addaxai-connect/uploads') }}" -type d -exec chmod 2775 {} \;
    find "{{ ftps_upload_dir | default('/opt/addaxai-connect/uploads') }}" -type d -exec chown {{ ftps_username | default('camera') }}:{{ ftps_username | default('camera') }} {} \;
  changed_when: false

- name: Add ubuntu user to camera group for Docker access
  user:
    name: "{{ app_user | default('ubuntu') }}"
    groups: "{{ ftps_username | default('camera') }}"
    append: yes

- name: Check if Let's Encrypt certificate exists
  stat:
    path: "/etc/letsencrypt/live/{{ domain_name | default('') }}/fullchain.pem"
  register: letsencrypt_cert_exists
  when: enable_ssl | default(false) and domain_name is defined and domain_name != ''

- name: Use Let's Encrypt certificate for FTPS (if available)
  block:
    - name: Remove old self-signed vsftpd certificate if exists
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/ssl/certs/vsftpd.crt
        - /etc/ssl/private/vsftpd.key

    - name: Create symlink for vsftpd cert to Let's Encrypt
      file:
        src: "/etc/letsencrypt/live/{{ domain_name }}/fullchain.pem"
        dest: /etc/ssl/certs/vsftpd.crt
        state: link
        force: yes

    - name: Create symlink for vsftpd key to Let's Encrypt
      file:
        src: "/etc/letsencrypt/live/{{ domain_name }}/privkey.pem"
        dest: /etc/ssl/private/vsftpd.key
        state: link
        force: yes
  when:
    - enable_ssl | default(false)
    - domain_name is defined and domain_name != ''
    - letsencrypt_cert_exists.stat.exists

- name: Generate self-signed SSL certificate for FTPS (fallback only)
  command: >
    openssl req -x509 -nodes -days 365 -newkey rsa:2048
    -keyout /etc/ssl/private/vsftpd.key
    -out /etc/ssl/certs/vsftpd.crt
    -subj "/C=US/ST=State/L=City/O=AddaxAI/CN={{ ansible_host }}"
  args:
    creates: /etc/ssl/certs/vsftpd.crt
  when: not (enable_ssl | default(false) and domain_name is defined and letsencrypt_cert_exists.stat.exists | default(false))

- name: Set permissions on SSL private key (self-signed fallback only)
  file:
    path: /etc/ssl/private/vsftpd.key
    mode: '0600'
    owner: root
    group: root
  when: not (enable_ssl | default(false) and domain_name is defined and letsencrypt_cert_exists.stat.exists | default(false))

- name: Deploy vsftpd configuration
  template:
    src: vsftpd.conf.j2
    dest: /etc/vsftpd.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart vsftpd

- name: Create vsftpd user list
  lineinfile:
    path: /etc/vsftpd.userlist
    line: "{{ ftps_username | default('camera') }}"
    create: yes
    owner: root
    group: root
    mode: '0600'

- name: Ensure vsftpd service is enabled and started
  systemd:
    name: vsftpd
    state: started
    enabled: yes

- name: Display FTPS connection information
  debug:
    msg: |
      ========================================
      FTPS Server Configured
      ========================================
      Host: {{ ansible_host }}
      Port: 21 (FTP), 990 (FTPS)
      Username: {{ ftps_username | default('camera') }}
      Upload directory: {{ ftps_upload_dir | default('/opt/addaxai-connect/uploads') }}

      Connect with: ftp://{{ ftps_username | default('camera') }}@{{ ansible_host }}
      Use FTPS (explicit TLS) for secure connection.
